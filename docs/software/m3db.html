

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>M3DB &mdash; Bookmarks rc documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="WireGuard" href="wireguard.html" />
    <link rel="prev" title="Random Software" href="index.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Bookmarks
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ruby/index.html">Ruby</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Random Software</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">M3DB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-m3db-storage-backend-and-etcd">Setting up M3DB storage backend and ETCD</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-m3-coordinator">Setup the M3 Coordinator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-prometheus">Setup Prometheus</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="wireguard.html">WireGuard</a></li>
<li class="toctree-l2"><a class="reference internal" href="mooltipass.html">Mooltipass</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bookmarks</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Random Software</a> &raquo;</li>
        
      <li>M3DB</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/software/m3db.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="m3db">
<span id="m3db"></span><h1>M3DB<a class="headerlink" href="#m3db" title="Permalink to this headline">¶</a></h1>
<p>M3DB is an open source project recently released by Uber that stores metrics over a simple
HTTP API. You can write to it with a simple CURL command using JSON or hookup Prometheus to
it. This will take a look at a general M3DB setup that allows you to hook up prometheus to it
when your storage backend sits on a different server than Prometheus.</p>
<p>This was derived from two posts on the m3db github site that you can read (here)<a class="reference external" href="https://m3db.github.io/m3/how_to/cluster_hard_way/">1</a> and (here)<a class="reference external" href="https://m3db.github.io/m3/integrations/prometheus/">2</a>.</p>
<div class="section" id="setting-up-m3db-storage-backend-and-etcd">
<span id="setting-up-m3db-storage-backend-and-etcd"></span><h2>Setting up M3DB storage backend and ETCD<a class="headerlink" href="#setting-up-m3db-storage-backend-and-etcd" title="Permalink to this headline">¶</a></h2>
<p>First we will create what the M3DB documentation calls a “Seed Node”. A seed node is a superset of
the storage node that in addition to storging your data runs ETCD which is responsible for keeping
track of all storage nodes in your cluster. In this case ETCD will keep track of the node it’s running
on since in this setup we are running them side by side.</p>
<p>Another thing to note is that the software with it’s default config needs at least 4GB to run even
at a very small scale which in my case is just scraping a few hundred metrics.</p>
<p>OK now to actually get started you will want to pull down the storage node config from (here)<a class="reference external" href="https://github.com/m3db/m3/blob/master/src/dbnode/config/m3dbnode-cluster-template.yml">3</a> and change
a few things.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">config</span><span class="p">:</span>
    <span class="n">service</span><span class="p">:</span>
      <span class="n">env</span><span class="p">:</span> <span class="n">default_env</span>
      <span class="n">zone</span><span class="p">:</span> <span class="n">embedded</span>
      <span class="n">service</span><span class="p">:</span> <span class="n">m3db</span>
      <span class="n">cacheDir</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">m3kv</span>
      <span class="n">etcdClusters</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">zone</span><span class="p">:</span> <span class="n">embedded</span>
          <span class="n">endpoints</span><span class="p">:</span>
            <span class="o">-</span> <span class="o">&lt;</span><span class="n">reachable_ip</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">2379</span>
    <span class="n">seedNodes</span><span class="p">:</span>
      <span class="n">initialCluster</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">hostID</span><span class="p">:</span> <span class="n">admin</span>
          <span class="n">endpoint</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">reachable_ip</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">2380</span>
</pre></div>
</div>
<p>Where reachable_ip is an IP that your prometheus instance on another box will still be able to talk to. In
my case this was just a public IP of my VM running on digital ocean. Additionally the hostID needs to match
my systems hostname this can be changed but I used the default config below which tells it to pull the hostID
of a node from the hostname.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">hostID</span><span class="p">:</span>
    <span class="n">resolver</span><span class="p">:</span> <span class="n">hostname</span>
</pre></div>
</div>
<p>After you have setup your config and edited to your liking run the following command to startup your instance.
Make sure to change the config path for your setup.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

docker run \
        --net host \
        --name m3db \
        -v $(pwd)/config/m3dbnode.yml:/etc/m3dbnode/m3dbnode.yml \
        -v /var/lib/m3db:/var/lib/m3db \
        -d \
        quay.io/m3/m3dbnode:latest
</pre></div>
</div>
<p>After this has started up you will need to initialize the database as well. Again make sure to
change out the id and hostname where it says admin for the hostID of your instance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">7201</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">placement</span><span class="o">/</span><span class="n">init</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{</span>
    <span class="s2">&quot;num_shards&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="s2">&quot;replication_factor&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isolation_group&quot;</span><span class="p">:</span> <span class="s2">&quot;nyc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;zone&quot;</span><span class="p">:</span> <span class="s2">&quot;embedded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;142.93.19.169:9000&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">9000</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span><span class="s1">&#39;</span>

<span class="n">sleep</span> <span class="mi">10</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">7201</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespace</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{</span>
  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;bootstrapEnabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;flushEnabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;writesToCommitLog&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;cleanupEnabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;snapshotEnabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;repairEnabled&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;retentionOptions&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;retentionPeriodDuration&quot;</span><span class="p">:</span> <span class="s2">&quot;720h&quot;</span><span class="p">,</span>
      <span class="s2">&quot;blockSizeDuration&quot;</span><span class="p">:</span> <span class="s2">&quot;12h&quot;</span><span class="p">,</span>
      <span class="s2">&quot;bufferFutureDuration&quot;</span><span class="p">:</span> <span class="s2">&quot;1h&quot;</span><span class="p">,</span>
      <span class="s2">&quot;bufferPastDuration&quot;</span><span class="p">:</span> <span class="s2">&quot;1h&quot;</span><span class="p">,</span>
      <span class="s2">&quot;blockDataExpiry&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;blockDataExpiryAfterNotAccessPeriodDuration&quot;</span><span class="p">:</span> <span class="s2">&quot;5m&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;indexOptions&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;blockSizeDuration&quot;</span><span class="p">:</span> <span class="s2">&quot;12h&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>After running this you you can tail the logs and you should see everything running smoothly. For a much more indepth
version of the above look at this (post)<a class="reference external" href="https://m3db.github.io/m3/how_to/cluster_hard_way/">1</a> which I highly recommend.</p>
</div>
<div class="section" id="setup-the-m3-coordinator">
<span id="setup-the-m3-coordinator"></span><h2>Setup the M3 Coordinator<a class="headerlink" href="#setup-the-m3-coordinator" title="Permalink to this headline">¶</a></h2>
<p>Now that we have the backend running and happy we need to setup the M3 Coordinator. This is a sidecar for prometheus
that will manage making the actual API calls needed to get data from the storage node.</p>
<p>To get started we just need to fill in a few config values again. Here is the config that I used you will only need
to change the reachable_ip provided you followed everything above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">listenAddress</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;config&quot;</span>
  <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0:7201&quot;</span>

<span class="n">metrics</span><span class="p">:</span>
  <span class="n">scope</span><span class="p">:</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="s2">&quot;coordinator&quot;</span>
  <span class="n">prometheus</span><span class="p">:</span>
    <span class="n">handlerPath</span><span class="p">:</span> <span class="o">/</span><span class="n">metrics</span>
    <span class="n">listenAddress</span><span class="p">:</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">7203</span> <span class="c1"># until https://github.com/m3db/m3/issues/682 is resolved</span>
  <span class="n">sanitization</span><span class="p">:</span> <span class="n">prometheus</span>
  <span class="n">samplingRate</span><span class="p">:</span> <span class="mf">1.0</span>
  <span class="n">extended</span><span class="p">:</span> <span class="n">none</span>

<span class="n">clusters</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">namespaces</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">default</span>
         <span class="n">retention</span><span class="p">:</span> <span class="mi">48</span><span class="n">h</span>
         <span class="nb">type</span><span class="p">:</span> <span class="n">unaggregated</span>
     <span class="n">client</span><span class="p">:</span>
       <span class="n">config</span><span class="p">:</span>
         <span class="n">service</span><span class="p">:</span>
           <span class="n">env</span><span class="p">:</span> <span class="n">default_env</span>
           <span class="n">zone</span><span class="p">:</span> <span class="n">embedded</span>
           <span class="n">service</span><span class="p">:</span> <span class="n">m3db</span>
           <span class="n">cacheDir</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">m3kv</span>
           <span class="n">etcdClusters</span><span class="p">:</span>
             <span class="o">-</span> <span class="n">zone</span><span class="p">:</span> <span class="n">embedded</span>
               <span class="n">endpoints</span><span class="p">:</span>
                 <span class="o">-</span> <span class="o">&lt;</span><span class="n">reachable_ip</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">2379</span>
       <span class="n">writeConsistencyLevel</span><span class="p">:</span> <span class="n">majority</span>
       <span class="n">readConsistencyLevel</span><span class="p">:</span> <span class="n">one</span>
       <span class="n">writeTimeout</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
       <span class="n">fetchTimeout</span><span class="p">:</span> <span class="mi">15</span><span class="n">s</span>
       <span class="n">connectTimeout</span><span class="p">:</span> <span class="mi">20</span><span class="n">s</span>
       <span class="n">writeRetry</span><span class="p">:</span>
         <span class="n">initialBackoff</span><span class="p">:</span> <span class="mi">500</span><span class="n">ms</span>
         <span class="n">backoffFactor</span><span class="p">:</span> <span class="mi">3</span>
         <span class="n">maxRetries</span><span class="p">:</span> <span class="mi">2</span>
         <span class="n">jitter</span><span class="p">:</span> <span class="n">true</span>
       <span class="n">fetchRetry</span><span class="p">:</span>
         <span class="n">initialBackoff</span><span class="p">:</span> <span class="mi">500</span><span class="n">ms</span>
         <span class="n">backoffFactor</span><span class="p">:</span> <span class="mi">2</span>
         <span class="n">maxRetries</span><span class="p">:</span> <span class="mi">3</span>
         <span class="n">jitter</span><span class="p">:</span> <span class="n">true</span>
       <span class="n">backgroundHealthCheckFailLimit</span><span class="p">:</span> <span class="mi">4</span>
       <span class="n">backgroundHealthCheckFailThrottleFactor</span><span class="p">:</span> <span class="mf">0.5</span>
</pre></div>
</div>
<p>Once this is written to disk you can run the following command to get it started.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

docker run \
        --net host \
        --name m3coordinator \
        -v $(pwd)/m3coordinator.yml:/etc/m3coordinator/m3coordinator.yml \
        -d \
        quay.io/m3/m3coordinator:latest
</pre></div>
</div>
</div>
<div class="section" id="setup-prometheus">
<span id="setup-prometheus"></span><h2>Setup Prometheus<a class="headerlink" href="#setup-prometheus" title="Permalink to this headline">¶</a></h2>
<p>Now that you have all the M3 pieces setup you just need to standup Prometheus and let it start scraping
some targets.</p>
<p>Here is the config that I used which will write to M3DB metrics that it scrapes from itself for easy testing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span><span class="p">:</span>
  <span class="n">scrape_interval</span><span class="p">:</span>     <span class="mi">15</span><span class="n">s</span>
  <span class="n">evaluation_interval</span><span class="p">:</span> <span class="mi">30</span><span class="n">s</span>

<span class="n">remote_read</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">url</span><span class="p">:</span> <span class="s2">&quot;http://0.0.0.0:7201/api/v1/prom/remote/read&quot;</span>
    <span class="c1"># To test reading even when local Prometheus has the data</span>
    <span class="n">read_recent</span><span class="p">:</span> <span class="n">true</span>

<span class="n">remote_write</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">url</span><span class="p">:</span> <span class="s2">&quot;http://0.0.0.0:7201/api/v1/prom/remote/write&quot;</span>

<span class="n">scrape_configs</span><span class="p">:</span>
  <span class="c1"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="s1">&#39;prometheus&#39;</span>

    <span class="c1"># metrics_path defaults to &#39;/metrics&#39;</span>
    <span class="c1"># scheme defaults to &#39;http&#39;.</span>

    <span class="n">static_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;0.0.0.0:9090&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>You can start this up with the following script</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

docker run \
        --net host \
        -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
        -d \
        --name prometheus \
        prom/prometheus
</pre></div>
</div>
<p>Now you should be able to go to &lt;your_ip&gt;:9090 and see metrics that are being ingested. What is super cool if you can
wait a few minutes destroy your container and start it again and all your metrics still exist!</p>
</div>
<div class="section" id="notes">
<span id="notes"></span><h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>I used host networking to make things easier but you can easily containerize all the networking if you wish. The official
M3DB and Prometheus docs provide all the info you need around port mappings. This guide mostly came about because I started
with the single node install on the docs and tried to run prometheus against it not knowing that the node the simple single
install sets up uses localhost for the instance which causes all sorts of run problems and strange errors.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wireguard.html" class="btn btn-neutral float-right" title="WireGuard" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Random Software" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Michael Schuett.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'rc',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>