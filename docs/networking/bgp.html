

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BGP &mdash; Bookmarks rc documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Junos OS" href="juniper.html" />
    <link rel="prev" title="Networking" href="index.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Bookmarks
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Networking</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">BGP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ecmp-equal-cost-multi-path-routing-anycast">ECMP (Equal Cost Multi-Path Routing / Anycast)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#route-distribution">Route distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#show-neighbors-routes">Show neighbors routes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#show-route-table-for-bgp-session">Show route table for bgp session</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="juniper.html">Junos OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="ciscocatalyst3560G.html">Cisco Catalyst 3560G Config</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ruby/index.html">Ruby</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/index.html">Random Software</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bookmarks</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Networking</a> &raquo;</li>
        
      <li>BGP</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/bgp.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bgp">
<span id="bgp"></span><h1>BGP<a class="headerlink" href="#bgp" title="Permalink to this headline">¶</a></h1>
<p>This document covers some basic documentation on using BGP in
a number of different ways.</p>
<div class="section" id="ecmp-equal-cost-multi-path-routing-anycast">
<span id="ecmp-equal-cost-multi-path-routing-anycast"></span><h2>ECMP (Equal Cost Multi-Path Routing / Anycast)<a class="headerlink" href="#ecmp-equal-cost-multi-path-routing-anycast" title="Permalink to this headline">¶</a></h2>
<p>In this example I am going to cover <a class="reference external" href="https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing">ECMP</a> setup using the quagga bgpd
daemon. ECMP will allow us to have multiple routes to the same CIDR block.
In most cases something like a /24 is handed out for a specific application
such as NTP. The idea of ECMP being that you could have a number of servers
sitting behind an IP such as 192.168.60.1 and as requests come in they are
sent to multiple physical hosts. If one fails it can quickly be removed and
any applications communicating with your service will be largely unaffected
as the update can happen in a matter of seconds.</p>
<p>Compare this to load balancing behind something like DNS where a record could
be cached in any number of locations causing consumers to continue to try
reading from a downed service. Additionally for services that are huge pains
to move such as DNS if you need to physically move your server and in doing so
give it a new IP you no longer have to care. Provided you already had ECMP in
the way I am about to show you setup you could continue broadcasting that you
own 192.168.60.1 at the new location.</p>
<p>With that being said lets take a look at a very simple setup using quagga and
the bgpd daemon installed on three different servers. To start with you can
run the following commands on a debian based OS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">quagga</span>

<span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">quagga</span><span class="o">/</span><span class="n">bgpd</span><span class="o">.</span><span class="n">conf</span>
<span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">quagga</span><span class="o">/</span><span class="n">zebra</span><span class="o">.</span><span class="n">conf</span>
<span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">quagga</span><span class="o">/</span><span class="n">vtysh</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>This will create the needed config files for you to start up your daemons. After
you have done this we will now setup the two nodes that you can think of as being
nodes that will contain our DNS service. On each one run the following commands</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">addr</span> <span class="n">add</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">60.1</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">lo</span>
</pre></div>
</div>
<p>This will add a new CIRD block to the loopback interface so we can now ping and
run a service on 192.168.60.1. Next we will configure bgpd on the two DNS servers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>eth1ip=$(ip addr show eth1 | grep -Po &#39;inet \K[\d.]+&#39;)

cat &gt; /etc/quagga/bgpd.conf &lt;&lt;EOF
!
! Zebra configuration saved from vty
!   2018/11/18 01:55:29
!
!
router bgp 200
 bgp router-id 10.10.12.102
 redistribute connected
 neighbor 10.10.12.101 remote-as 100
! no auto-summary
!
 address-family ipv6
 exit-address-family
 exit
!
line vty
!
EOF
</pre></div>
</div>
<p>This will create a bgp route for asn 200 and set the router-id which is used by
other routers to identify your client. You can use anything but your public IP
or the IP that other bgp daemons will reach you at is commonly used. The neighbor
command is specifying the IP at which we will establish a bgp session and the asn
that we expect it to have which is 100 in this case.</p>
<p>To dig into more of the commands and also change this to your liking check out the
quagga <a class="reference external" href="https://www.quagga.net/docs/quagga.html#BGP">docs</a>. Now start up the bgpd and zebra daemon.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">zebra</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">bgpd</span>
</pre></div>
</div>
<p>After setting up the above on both DNS nodes lets now setup the node that will be doing
the actual ECMP routing. In our case it’s just another server running qugga but in production
this is likely a router such as cisco or juniper.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cat &gt; /etc/quagga/bgpd.conf &lt;&lt;EOF
!
! Zebra configuration saved from vty
!   2018/11/16 05:15:45
!
router bgp 100
 bgp router-id 10.10.12.101
 neighbor 10.10.12.102 remote-as 200
 neighbor 10.10.12.102 route-map r60 in
 neighbor 10.10.12.103 remote-as 200
 neighbor 10.10.12.103 route-map r60 in
 maximum-paths 2
!
 address-family ipv6
 exit-address-family
 exit
!
access-list 10 permit 192.168.60.0 0.0.0.255
!
route-map r60 permit 10
 match ip address 10
!
line vty
!
EOF
</pre></div>
</div>
<p>This case is very similar to the last config except we now specify the names of the two BGP
servers. We additionally add a route-map to each of the neighbors so that we only get routes
that we are expecting from them. Without this they would be allowed to send any
routes they want and I believe they could even overwrite public routes. To break down
how this is working first we define an access-list with the name of 10. This could
have anything in it’s place. we permit 192.168.60.0/24 and add it to a route-map
called r60 that will permit the route to be redistributed. Additionally the route-map
is given sequence number ten which if multiple route-maps are use decides when the map
is evaluated lowest comes first. The match ip address 10 is saying that we will match
against the ip address in access-list 10.</p>
<p>Additionally route-maps are a bit tricky and if you are interested in really understanding
them <a class="reference external" href="https://www.cisco.com/c/en/us/td/docs/security/asa/asa84/configuration/guide/asa_84_cli_config/route_maps.pdf">read this</a>.</p>
<p>The maximum-paths 2 is where we are allowing the ECMP magic to happen. With out this quagga
will only allow one path to be entered into the routing table. If you want to have more paths
increase this number.</p>
<p>When the BGP session is established they will broadcast what routes they know about
which in our case is the 192.168.60.0/24 which we created above. Start zebra and bgpd and you
should see an entry in your routing table now that looks like this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@debian1</span><span class="p">:</span><span class="o">~</span><span class="c1"># ip route</span>
<span class="n">default</span> <span class="n">via</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">2.2</span> <span class="n">dev</span> <span class="n">eth0</span> 
<span class="mf">10.0</span><span class="o">.</span><span class="mf">2.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">kernel</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">src</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">2.15</span> 
<span class="mf">10.10</span><span class="o">.</span><span class="mf">12.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">eth1</span> <span class="n">proto</span> <span class="n">kernel</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">src</span> <span class="mf">10.10</span><span class="o">.</span><span class="mf">12.101</span> 
<span class="mf">192.168</span><span class="o">.</span><span class="mf">60.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">proto</span> <span class="n">zebra</span> <span class="n">metric</span> <span class="mi">20</span> 
        <span class="n">nexthop</span> <span class="n">via</span> <span class="mf">10.10</span><span class="o">.</span><span class="mf">12.102</span>  <span class="n">dev</span> <span class="n">eth1</span> <span class="n">weight</span> <span class="mi">1</span>
        <span class="n">nexthop</span> <span class="n">via</span> <span class="mf">10.10</span><span class="o">.</span><span class="mf">12.103</span>  <span class="n">dev</span> <span class="n">eth1</span> <span class="n">weight</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Try listening on a port with netcat and then telnet to 192.168.60.1 swice to see what happens.
This is a very basic example of what you can do with BGP and ECMP and I also have a vagrantfile
for those who want to easily play around with this <a class="reference external" href="https://github.com/michaeljs1990/testlabs/tree/master/anycast">here</a>.</p>
</div>
<div class="section" id="route-distribution">
<span id="route-distribution"></span><h2>Route distribution<a class="headerlink" href="#route-distribution" title="Permalink to this headline">¶</a></h2>
<p>You can pick what route you want to send to hosts in multiple ways two of the most useful are
manually setting it with network or just passing everything on with redistribute.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">router</span> <span class="n">bgp</span> <span class="mi">100</span>
  <span class="n">redistribute</span> <span class="n">connected</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">router</span> <span class="n">bgp</span> <span class="mi">100</span>
  <span class="n">network</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">60.0</span> <span class="n">mask</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span>
</pre></div>
</div>
</div>
<div class="section" id="show-neighbors-routes">
<span id="show-neighbors-routes"></span><h2>Show neighbors routes<a class="headerlink" href="#show-neighbors-routes" title="Permalink to this headline">¶</a></h2>
<p>If you ever are having issues getting the routes to show up you can see what the following command
outputs by hopping on a neighbor you are connecting to and running the following. This will output
a bunch of information about the state of the routes as well as what ones it’s getting.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show</span> <span class="n">ip</span> <span class="n">bgp</span> <span class="n">neighbors</span> <span class="mf">10.10</span><span class="o">.</span><span class="mf">12.103</span> <span class="n">routes</span>
</pre></div>
</div>
</div>
<div class="section" id="show-route-table-for-bgp-session">
<span id="show-route-table-for-bgp-session"></span><h2>Show route table for bgp session<a class="headerlink" href="#show-route-table-for-bgp-session" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show</span> <span class="n">ip</span> <span class="n">bgp</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="juniper.html" class="btn btn-neutral float-right" title="Junos OS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Networking" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Michael Schuett.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'rc',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>